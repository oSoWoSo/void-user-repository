name: Update templatesList and workflow
on:
  push:
    branches:
      - main
    paths:
      - 'srcpkgs/**'
      - '.github/build-REST.yml'
      - '.github/build-START.yml'
  workflow_dispatch:
permissions:
  contents: write
  actions: write
jobs:
  list-templates:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.WORKFLOWS }}
          fetch-depth: 2  # shallow clone

      - name: Update templatesList and detect new packages
        id: detect
        run: |
          # Get old templatesList
          git show HEAD~1:.github/templatesList > old_templatesList 2>/dev/null || touch old_templatesList

          # Create new templateList
          rm -f .github/templatesList
          find srcpkgs/* -maxdepth 0 -type d | cut -d'/' -f2 | sort | tee .github/templatesList

          # Find new templates
          comm -13 old_templatesList .github/templatesList > new_templates.txt

          # Count new templates
          NEW_COUNT=$(wc -l < new_templates.txt)
          echo "new_count=$NEW_COUNT" >> $GITHUB_OUTPUT

          if [ "$NEW_COUNT" -eq 1 ]; then
            # Only 1 new template
            SINGLE_TEMPLATE=$(cat new_templates.txt)
            echo "single_template=$SINGLE_TEMPLATE" >> $GITHUB_OUTPUT
            echo "templates=" >> $GITHUB_OUTPUT
            echo "==> Found 1 new template: $SINGLE_TEMPLATE"
          elif [ "$NEW_COUNT" -gt 1 ]; then
            # More new templates
            MULTIPLE_TEMPLATES=$(cat new_templates.txt | tr '\n' ' ' | sed 's/ $//')
            echo "single_template=" >> $GITHUB_OUTPUT
            echo "templates=$MULTIPLE_TEMPLATES" >> $GITHUB_OUTPUT
            echo "==> Found $NEW_COUNT new templates: $MULTIPLE_TEMPLATES"
          else
            echo "==> No new templates found"
            echo "single_template=" >> $GITHUB_OUTPUT
            echo "templates=" >> $GITHUB_OUTPUT
          fi

      - name: Update README
        run: |
          sed -i '/## Available packages/,$!w temp.md' README.md
          sed -i '/## The `vay` script/,$w end.md' README.md
          echo "## Available packages" >> temp.md
          echo "| package | version | homepage | maintainer | notes |" >> temp.md
          echo "|:--------|:--------|:---------|:-----------|:------|" >> temp.md
          while IFS= read -r line; do
            package=$line
            template_file="srcpkgs/$line/template"
            if [ -f "$template_file" ]; then
              homepage=$(grep '^homepage=' "$template_file" | cut -d '=' -f2 | cut -d'"' -f2)
              version=$(grep '^version=' "$template_file" | cut -d '=' -f2)
              maintainer=$(grep '^maintainer=' "$template_file" | cut -d '=' -f2 | cut -d' ' -f1 | cut -d'"' -f2)
              notes=$(grep '^archs=' "$template_file" | cut -d'=' -f2 | cut -d'"' -f2)
              echo "| $package | $version | $homepage | $maintainer | $notes |" >> temp.md
            fi
          done < .github/templatesList
          cat end.md >> temp.md
          mv temp.md README.md
          rm end.md

      - name: Update build workflow
        run: |
          cd .github/workflows
          cp -f ../build-START.yml build.yml
          while read -r line; do
            echo "        - $(echo "$line")"
          done < ../templatesList >> build.yml
          cat ../build-REST.yml >> build.yml

      - name: Push results
        env:
          TOKEN: ${{ secrets.WORKFLOWS }}
        run: |
          git config --global user.name "web-flow"
          git config --global user.email "noreply@github.com"
          git add README.md || echo "README.md not added"
          git add .github/templatesList || echo "templatesList not added"
          git add .github/workflows/build.yml || echo "build.yml not added"
          git commit -m "CI: update" || echo "Nothing to commit"
          git push || echo "Nothing to push"
          git status

      - name: Trigger build workflow
        if: steps.detect.outputs.new_count > 0
        env:
          GH_TOKEN: ${{ secrets.WORKFLOWS }}
        run: |
          NEW_COUNT="${{ steps.detect.outputs.new_count }}"
          SINGLE="${{ steps.detect.outputs.single_template }}"
          MULTIPLE="${{ steps.detect.outputs.templates }}"

          # Wait a bit for push (Just in case)
          sleep 5

          if [ "$NEW_COUNT" -eq 1 ]; then
            echo "==> Triggering build for single template: $SINGLE"
            gh workflow run build.yml -f template="$SINGLE"
          elif [ "$NEW_COUNT" -gt 1 ]; then
            echo "==> Triggering build for multiple templates: $MULTIPLE"
            gh workflow run build.yml -f templates="$MULTIPLE"
          fi

          echo "==> Build workflow triggered successfully"
