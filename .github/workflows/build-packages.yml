name: build packages

on:
  push:
    branches:
        - main
    paths:
        - 'srcpkgs/**'
  workflow_dispatch:

jobs:
  detect-changes:
    name: Detect changed packages
    runs-on: ubuntu-latest
    outputs:
      changed_packages: ${{ steps.changes.outputs.packages }}
      has_changes: ${{ steps.changes.outputs.has_changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed packages
        id: changes
        run: |
          # Get changed files in srcpkgs/
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # For manual runs, build all packages
            CHANGED_DIRS=$(find srcpkgs -maxdepth 1 -mindepth 1 -type d -printf "%f\n" | tr '\n' ' ')
          else
            # Get files changed in this push
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} -- srcpkgs/)
            
            if [ -z "$CHANGED_FILES" ]; then
              echo "has_changes=false" >> "$GITHUB_OUTPUT"
              echo "packages=" >> "$GITHUB_OUTPUT"
              echo "No changes detected in srcpkgs/"
              exit 0
            fi
            
            # Extract unique package directories
            CHANGED_DIRS=$(echo "$CHANGED_FILES" | cut -d'/' -f2 | sort -u | tr '\n' ' ')
          fi
          
          echo "has_changes=true" >> "$GITHUB_OUTPUT"
          echo "packages=$CHANGED_DIRS" >> "$GITHUB_OUTPUT"
          echo "Changed packages: $CHANGED_DIRS"

  build:
    name: Build packages
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/void-linux/void-${{ matrix.config.libc }}-full:20250616R1
      options: --platform ${{ matrix.config.platform }} --privileged
      volumes:
        - /dev:/dev
      env:
        ARCH: '${{ matrix.config.arch }}'
        BOOTSTRAP: '${{ matrix.config.host }}'
        TEST: '${{ matrix.config.test }}'
    strategy:
      fail-fast: false
      matrix:
        config:
          - { arch: x86_64,       host: x86_64,      libc: glibc, platform: linux/amd64, test: 1 }
          - { arch: aarch64,      host: x86_64,      libc: glibc, platform: linux/amd64, test: 0 }
          - { arch: x86_64-musl,  host: x86_64-musl, libc: musl,  platform: linux/amd64, test: 1 }
          - { arch: aarch64-musl, host: x86_64-musl, libc: musl,  platform: linux/amd64, test: 0 }

    permissions:
      contents: write

    steps:
      - name: Prepare container
        run: |
          # switch to repo-ci mirror
          mkdir -p /etc/xbps.d && cp /usr/share/xbps.d/*-repository-*.conf /etc/xbps.d/
          sed -i 's|repo-default|repo-ci|g' /etc/xbps.d/*-repository-*.conf
          # install dependencies
          xbps-install -Syu xbps && xbps-install -yu && xbps-install -y sudo bash curl git
          # create non-root user
          useradd -G xbuilder -M builder

      - name: Checkout this repo
        run: |
          git clone --depth 1 "https://github.com/${{ github.repository }}.git" extra
          cd extra
          git fetch --no-tags origin "${{ github.sha }}" --depth 1
          git checkout --detach "${{ github.sha }}"

      - name: Checkout void-packages
        run: |
          git clone https://github.com/void-linux/void-packages.git void-packages
          cd void-packages
          git checkout --detach master

      - name: Merge templates and edit shlibs
        run: |
          echo "==> copying templates..."
          for template in extra/srcpkgs/*; do
            template_name=$(basename "$template")
            original="void-packages/srcpkgs/$template_name"
            if [ -d "$original" ]; then
              echo "Removing old template directory: $template
              rm -rf "$original" || echo "Cannot remove $original"
              cp -rfv extra/srcpkgs/$template void-packages/srcpkgs/
            fi
          done

          SHLIBS_FILE="void-packages/common/shlibs"
          APPEND_FILE="extra/shlibs_append"
          REMOVE_FILE="extra/shlibs_remove"

          echo "==> updating common/shlibs..."
          if [ -f "$REMOVE_FILE" ]; then
            while IFS= read -r line; do
              [ -z "$line" ] && continue
              grep -vF "$line" "$SHLIBS_FILE" > "$SHLIBS_FILE.tmp" && mv "$SHLIBS_FILE.tmp" "$SHLIBS_FILE"
              echo "   - removed: $line"
            done < "$REMOVE_FILE"
          fi

          if [ -f "$APPEND_FILE" ]; then
            while IFS= read -r line; do
              [ -z "$line" ] && continue
              if ! grep -qF "$line" "$SHLIBS_FILE"; then
                echo "$line" >> "$SHLIBS_FILE"
                echo "   + added: $line"
              fi
            done < "$APPEND_FILE"
          fi

          #echo "=> applying inline edits..."
          #if [ -d "void-packages/srcpkgs/hyprutils/patches" ]; then
          #    echo "   - removing void-packages/srcpkgs/hyprutils/patches"
          #    rm -rf void-packages/srcpkgs/hyprutils/patches
          #fi

      - name: Prepare masterdir
        run: |
          cd void-packages
          chown -R builder:builder . &&
          sudo -Eu builder common/travis/set_mirror.sh &&
          sudo -Eu builder common/travis/prepare.sh &&
          common/travis/fetch-xtools.sh

      - name: Build changed packages
        env:
          CHANGED_PACKAGES: ${{ needs.detect-changes.outputs.changed_packages }}
        run: |
          export PATH="/opt/xbps/usr/bin/:$PATH"
          cd void-packages
          
          # Build only changed packages
          pkgs="${CHANGED_PACKAGES}"
          echo "==> Building changed packages: $pkgs"
          
          if [ "$BOOTSTRAP" != "$ARCH" ]; then
              arch="-a $ARCH"
          fi

          if [ "$TEST" = 1 ]; then
              test="-Q"
          fi

          # Sort dependencies for changed packages only
          PKGS=$(sudo -Eu builder ./xbps-src $test sort-dependencies $pkgs)
          failed=""

          echo "==> Build order with dependencies:"
          echo "$PKGS"
          echo

          for pkg in ${PKGS}; do
            echo "==> Building ${pkg}..."
            if ! sudo -Eu builder ./xbps-src -j"$(nproc)" -s $arch $test pkg "${pkg}"; then
              echo "!! build failed for ${pkg}"
              failed="${failed} ${pkg}"
            fi
          done

          if [ -n "${failed}" ]; then
            echo
            echo "These packages failed:"
            for f in ${failed}; do
                echo "  - ${f}"
            done
            exit 1
          fi

      - name: Sign packages
        env:
          PRIV_KEY: ${{ secrets.PRIV_KEY }}
        working-directory: void-packages/hostdir/binpkgs/
        run: |
          export PATH="/opt/xbps/usr/bin/:$PATH"

          echo "==> writing private key to file..."
          printf "%s\n" "$PRIV_KEY" > private.pem
          echo "==> merging free + nonfree"
          if [ -d "nonfree" ]; then
              mv nonfree/*.xbps . 2>/dev/null || true
          fi

          # Index and sign packages
          xbps-rindex -a *.xbps 2>/dev/null || true
          xbps-rindex -r "$PWD"
          xbps-rindex -s --signedby "zenobit <zenobit@disroot.org>" --privkey private.pem "$PWD"
          xbps-rindex -S --privkey private.pem "$PWD"/*.xbps
          xbps-rindex -c "$PWD"

          echo "==> cleaning up private key..."
          rm -f private.pem

      - name: Push to separate repository
        env:
          REPO_OWNER: ${{ github.repository_owner }}
          TOKEN: ${{ secrets.TOKEN }}
          ARCH: ${{ matrix.config.arch }}
        run: |
          export PATH="/opt/xbps/usr/bin/:$PATH"
          
          # Repository name based on architecture
          REPO_NAME="VUR-${ARCH}"
          REMOTE="https://${REPO_OWNER}:${TOKEN}@github.com/${REPO_OWNER}/${REPO_NAME}.git"
          
          echo "==> Target repository: ${REPO_OWNER}/${REPO_NAME}"
          
          # Create temporary directory for the repository
          mkdir -p /tmp/repo
          cd /tmp/repo
          
          # Initialize git
          git init
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Setup Git LFS
          git lfs install
          
          # Try to clone existing repository
          echo "==> Attempting to clone existing repository..."
          if git clone --depth 1 "$REMOTE" existing 2>/dev/null; then
            echo "==> Repository exists, replacing old packages with new ones..."
            cd existing
            
            # Get list of new packages (base names without version)
            NEW_PKGS=$(cd /void-packages/hostdir/binpkgs && ls *.xbps 2>/dev/null | sed 's/-[0-9].*//' | sort -u)
            
            # Remove old versions of packages that we're updating
            for pkg in $NEW_PKGS; do
              echo "==> Removing old versions of: ${pkg}"
              rm -f ${pkg}-*.xbps 2>/dev/null || true
            done
            
            # Copy new packages
            cp /void-packages/hostdir/binpkgs/*.xbps . 2>/dev/null || true
            
            # Re-index everything
            xbps-rindex -a *.xbps 2>/dev/null || true
            xbps-rindex -r "$PWD"
            
            # Sign if key is available
            if [ -n "${{ secrets.PRIV_KEY }}" ]; then
              printf "%s\n" "${{ secrets.PRIV_KEY }}" > private.pem
              xbps-rindex -s --signedby "zenobit <zenobit@disroot.org>" --privkey private.pem "$PWD"
              xbps-rindex -S --privkey private.pem "$PWD"/*.xbps
              rm -f private.pem
            fi
            
            xbps-rindex -c "$PWD"
            
            # Remove old LFS objects and re-track
            #git lfs uninstall
            git lfs install
            
            git add .
            git commit -m "Update packages - $(date +'%Y-%m-%d %H:%M:%S')" || true
            git push origin main
          else
            echo "==> Repository doesn't exist, creating new one..."
            cd /tmp/repo
            
            # Copy packages to new repo
            cp /void-packages/hostdir/binpkgs/*.xbps . 2>/dev/null || true
            cp /void-packages/hostdir/binpkgs/*-repodata . 2>/dev/null || true
            
            # Setup Git LFS for .xbps files
            echo "*.xbps filter=lfs diff=lfs merge=lfs -text" > .gitattributes
            git add .gitattributes
            
            # Create README
            cat > README.md << EOF
          # Void User Repository - ${ARCH}
          
          Binary package repository for Void Linux (${ARCH} architecture).
          
          This is a rolling release repository - only the latest version of each package is kept.
          
          ## Usage
          
          Add this repository to your system:
          
          \`\`\`bash
          sudo mkdir -p /etc/xbps.d
          echo "repository=https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}" | sudo tee /etc/xbps.d/00-${REPO_NAME}.conf
          \`\`\`
          
          Then update and install packages:
          
          \`\`\`bash
          sudo xbps-install -S
          sudo xbps-install <package-name>
          \`\`\`
          
          ## Note
          
          - This repository uses Git LFS for storing binary packages
          - Old package versions are automatically replaced with newer ones
          - This repository is automatically built and updated by GitHub Actions
          - Templates are in https://github.com/oSoWoSo/void-user-repository
          
          Last updated: $(date +'%Y-%m-%d %H:%M:%S UTC')
          EOF
            
            git add .
            git commit -m "Initial commit - packages for ${ARCH}"
            git branch -M main
            git push -u "$REMOTE" main
          fi
          
          echo "==> Successfully pushed to ${REPO_OWNER}/${REPO_NAME}"
