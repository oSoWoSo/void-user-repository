name: matrix build

on:
  pull_request:
    paths:
      - 'srcpkgs/**'
  repository_dispatch:
    types: [build]
  workflow_dispatch:
    inputs:
      all:
        description: 'Rebuild everything'
        required: false
        default: false
        type: boolean
      templates:
        description: 'Build multiple packages'
        required: false
        type: string
      template:
        description: 'Build single package'
        required: false
        type: choice
        options:
        -
        - aquamarine
        - btrfs-progs
        - glaze
        - hyprcursor
        - hyprdynamicmonitors
        - hyprgraphics
        - hypridle
        - hyprland
        - hyprland-guiutils
        - hyprland-protocols
        - hyprland-qt-support
        - hyprlang
        - hyprlock
        - hyprpaper
        - hyprpicker
        - hyprpolkitagent
        - hyprsunset
        - hyprsysteminfo
        - hyprtoolkit
        - hyprutils
        - hyprwayland-scanner
        - libspng
        - linuxcommandlibrary
        - ly
        - nebula-gtk
        - sdbus-cpp
        - shattered-pixel-dungeon
        - tomlplusplus
        - vbm
        - xdg-desktop-portal-hyprland
        - zen-browser
        - zig
permissions:
  contents: write
  pull-requests: read

jobs:
  lint:
    name: Lint templates
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/void-linux/void-glibc-full:20250616R1
      options: --platform linux/amd64 --privileged
    outputs:
      packages: ${{ steps.lint.outputs.packages }}
      removed: ${{ steps.lint.outputs.removed }}
    steps:
      - name: Prepare container
        run: |
          mkdir -p /etc/xbps.d && cp /usr/share/xbps.d/*-repository-*.conf /etc/xbps.d/
          sed -i 's|repo-default|repo-ci|g' /etc/xbps.d/*-repository-*.conf
          xbps-install -Syu xbps && xbps-install -yu && xbps-install -y sudo bash curl git git-lfs
          useradd -G xbuilder -M builder

      - name: Checkout this repo
        run: |
          git clone --depth 1 "https://github.com/${{ github.repository }}.git" extra
          cd extra
          git fetch --no-tags origin "${{ github.sha }}" --depth 1
          git checkout --detach "${{ github.sha }}"

      - name: Checkout void-packages
        run: |
          git clone --depth 1 https://github.com/void-linux/void-packages.git void-packages

      - name: Prepare masterdir
        run: |
          cd void-packages
          chown -R builder:builder .
          sudo -Eu builder common/travis/set_mirror.sh
          sudo -Eu builder common/travis/prepare.sh
          common/travis/fetch-xtools.sh

      - name: Lint
        id: lint
        run: |
          export PATH="/opt/xbps/usr/bin/:$PATH"

          # Determine which templates to process
          packages=""
          removed=""

          # All templates
          if [ "${{ inputs.all }}" = "true" ]; then
            packages=$(find extra/srcpkgs -maxdepth 1 -mindepth 1 -type d -printf "%f " | sed 's/ $//')
          # Single template
          elif [ -n "${{ inputs.template }}" ]; then
            packages=${{ inputs.template }}
          # Multiple templates (space-separated)
          elif [ -n "${{ inputs.templates }}" ]; then
            packages=$(printf '%s ' ${{ inputs.templates }} | sed 's/ $//')
          # PR mode - detect changes
          else
            # PR mode - detect changes
            cd extra
            base="${{ github.event.pull_request.base.sha }}"
            tip="${{ github.event.pull_request.head.sha }}"

            changed_pkgs=$(git diff --name-only "$base" "$tip" -- 'srcpkgs/*/template' \
              | cut -d/ -f2 \
              | sort -u \
              | tr '\n' ' ' \
              | sed 's/ $//')
            removed_pkgs=$(git diff --name-status "$base" "$tip" -- 'srcpkgs/*/template' \
              | awk '$1=="D"{print $2}' \
              | cut -d/ -f2 \
              | sort -u \
              | tr '\n' ' ' \
              | sed 's/ $//')

            packages="$changed_pkgs"
            removed="$removed_pkgs"
            cd ..
          fi

          echo "Chosen templates: ${packages:-<none>}"
          echo "Removed templates: ${removed:-<none>}"

          if [ -z "$packages" ] && [ -z "$removed" ]; then
            echo "No packages to lint"
            exit 1
          elif [ -z "$packages" ] && [ -n "$removed" ]; then
            exit 0
          fi

          # Lint templates
          cd void-packages
          failed=""

          for template_name in $packages; do
            SOURCE="../extra/srcpkgs/$template_name"
            DESTINATION="srcpkgs/$template_name"

            if [ ! -d "$SOURCE" ]; then
              echo "❌ Template not found: $SOURCE"
              continue
            fi

            echo "==> Copying ${template_name}"
            rm -rf "$DESTINATION"
            cp -rv "$SOURCE" srcpkgs/

            echo "==> Linting ${template_name}"

            # Capture output and exit code
            OUTPUT=$(sudo -Eu builder xlint "${template_name}" 2>&1) || LINT_FAILED=true
            if [ -n "$OUTPUT" ] || [ "$LINT_FAILED" = true ]; then
              echo "## ❌ ${template_name} lint failed:" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "$OUTPUT" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "❌ ${template_name} lint failed"
              failed="${failed} ${template_name}"
            else
              echo "✅ ${template_name} lint passed"
            fi
            echo
          done

          if [ -n "${failed}" ]; then
            packages_clean="$packages"
            for fail in $failed; do
              packages_clean=$(echo "$packages_clean" | sed "s/\b$fail\b//g")
            done
            packages=$(echo "$packages_clean" | xargs)
            echo "⚠️ Continuing with successful packages: $packages"
            echo "packages=$packages" >> "$GITHUB_OUTPUT"
            if [ -n "$removed" ]; then
              echo "removed=$removed" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "✅ All lints passed"
            echo "packages=$packages" >> "$GITHUB_OUTPUT"
            if [ -n "$removed" ]; then
              echo "removed=$removed" >> "$GITHUB_OUTPUT"
            fi
          fi

  test-pr:
    name: Test PR changes
    needs: lint
    if: github.event_name == 'pull_request' && needs.lint.outputs.packages != ''
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/void-linux/void-${{ matrix.config.libc }}-full:20250616R1
      options: --platform ${{ matrix.config.platform }} --privileged
      volumes:
        - /dev:/dev
      env:
        ARCH: '${{ matrix.config.arch }}'
        BOOTSTRAP: '${{ matrix.config.host }}'
        TEST: '${{ matrix.config.test }}'
    strategy:
      fail-fast: false
      matrix:
        config:
          - { arch: x86_64,       host: x86_64,      libc: glibc, platform: linux/amd64, test: 1 }
          - { arch: aarch64,      host: x86_64,      libc: glibc, platform: linux/amd64, test: 0 }
          - { arch: x86_64-musl,  host: x86_64-musl, libc: musl,  platform: linux/amd64, test: 1 }
          - { arch: aarch64-musl, host: x86_64-musl, libc: musl,  platform: linux/amd64, test: 0 }

    steps:
      - name: Prepare container
        run: |
          # switch to repo-ci mirror
          mkdir -p /etc/xbps.d && cp /usr/share/xbps.d/*-repository-*.conf /etc/xbps.d/
          sed -i 's|repo-default|repo-ci|g' /etc/xbps.d/*-repository-*.conf
          # install dependencies
          xbps-install -Syu xbps && xbps-install -yu && xbps-install -y sudo bash curl git
          # create non-root user
          useradd -G xbuilder -M builder

      - name: Checkout repo (PR head)
        run: |
          git clone --depth 1 "https://github.com/${{ github.repository }}.git" extra
          cd extra
          git fetch --no-tags origin "${{ github.event.pull_request.head.sha }}" --depth 1
          git checkout --detach "${{ github.event.pull_request.head.sha }}"

      - name: Checkout void-packages
        run: |
          git clone --depth 1 https://github.com/void-linux/void-packages.git void-packages

      - name: Merge templates and edit shlibs
        run: |
          echo "==> Copying templates"
          packages="${{ needs.lint.outputs.packages }}"
          for pkg in $packages; do
            if [ -d "extra/srcpkgs/$pkg" ]; then
              echo "  Copying: $pkg"
              rm -rf "void-packages/srcpkgs/$pkg"
              cp -rv "extra/srcpkgs/$pkg" void-packages/srcpkgs/
            fi
          done

          SHLIBS_FILE="void-packages/common/shlibs"
          APPEND_FILE="extra/shlibs_append"
          REMOVE_FILE="extra/shlibs_remove"

          echo "==> Updating common/shlibs"
          if [ -f "$REMOVE_FILE" ]; then
            while IFS= read -r line; do
              [ -z "$line" ] && continue
              grep -vF "$line" "$SHLIBS_FILE" > "$SHLIBS_FILE.tmp" && mv "$SHLIBS_FILE.tmp" "$SHLIBS_FILE"
              echo "   - removed: $line"
            done < "$REMOVE_FILE"
          fi

          if [ -f "$APPEND_FILE" ]; then
            while IFS= read -r line; do
              [ -z "$line" ] && continue
              if ! grep -qF "$line" "$SHLIBS_FILE"; then
                echo "$line" >> "$SHLIBS_FILE"
                echo "   + added: $line"
              fi
            done < "$APPEND_FILE"
          fi

      - name: Prepare masterdir
        run: |
          cd void-packages
          chown -R builder:builder .
          sudo -Eu builder common/travis/set_mirror.sh
          sudo -Eu builder common/travis/prepare.sh
          common/travis/fetch-xtools.sh

      - name: Build
        run: |
          export PATH="/opt/xbps/usr/bin/:$PATH"
          cd void-packages

          packages="${{ needs.lint.outputs.packages }}"

          if [ "$BOOTSTRAP" != "$ARCH" ]; then
            arch="-a $ARCH"
          fi

          if [ "$TEST" = 1 ]; then
            test="-Q"
          fi

          echo "==> Resolving dependencies for: $packages"
          PKGS=$(sudo -Eu builder ./xbps-src $test sort-dependencies $packages)
          failed=""

          echo "==> Build order with dependencies:"
          echo "$PKGS"
          echo

          for pkg in ${PKGS}; do
            echo "==> Building ${pkg}"
            if ! sudo -Eu builder ./xbps-src -j"$(nproc)" -s $arch $test pkg "${pkg}"; then
              echo "❌ build failed: ${pkg}"
              failed="${failed} ${pkg}"
            else
              echo
              echo "✅ ${pkg} built successfully"
            fi
            echo
            echo
          done

          if [ -n "${failed}" ]; then
            echo "## ❌ Failed builds" >> $GITHUB_STEP_SUMMARY
            for f in ${failed}; do
              echo "  - ${f}" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo
            echo "✅ All builds succeeded"
          fi

  build:
    name: Build packages
    needs: lint
    if: github.event_name != 'pull_request' && needs.lint.outputs.packages != ''
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/void-linux/void-${{ matrix.config.libc }}-full:20250616R1
      options: --platform ${{ matrix.config.platform }} --privileged
      volumes:
        - /dev:/dev
      env:
        ARCH: '${{ matrix.config.arch }}'
        BOOTSTRAP: '${{ matrix.config.host }}'
        TEST: '${{ matrix.config.test }}'
    strategy:
      fail-fast: false
      matrix:
        config:
          - { arch: x86_64,       host: x86_64,      libc: glibc, platform: linux/amd64, test: 1 }
          - { arch: aarch64,      host: x86_64,      libc: glibc, platform: linux/amd64, test: 0 }
          - { arch: x86_64-musl,  host: x86_64-musl, libc: musl,  platform: linux/amd64, test: 1 }
          - { arch: aarch64-musl, host: x86_64-musl, libc: musl,  platform: linux/amd64, test: 0 }

    steps:
      - name: Prepare container
        run: |
          mkdir -p /etc/xbps.d && cp /usr/share/xbps.d/*-repository-*.conf /etc/xbps.d/
          sed -i 's|repo-default|repo-ci|g' /etc/xbps.d/*-repository-*.conf
          xbps-install -Syu xbps && xbps-install -yu && xbps-install -y sudo bash curl git git-lfs
          useradd -G xbuilder -M builder

      - name: Checkout this repo
        run: |
          git clone --depth 1 "https://github.com/${{ github.repository }}.git" extra
          cd extra
          git fetch --no-tags origin "${{ github.sha }}" --depth 1
          git checkout --detach "${{ github.sha }}"

      - name: Checkout void-packages
        run: |
          git clone --depth 1 https://github.com/void-linux/void-packages.git void-packages

      - name: Merge templates and edit shlibs
        run: |
          packages="${{ needs.lint.outputs.packages }}"
          for template_name in $packages; do
            SOURCE="extra/srcpkgs/$template_name"
            DESTINATION="void-packages/srcpkgs/$template_name"

            if [ ! -d "$SOURCE" ]; then
              echo "❌ Template not found: $SOURCE"
              continue
            fi

            # If destination doesn't exist, copy immediately
            if [ ! -d "$DESTINATION" ]; then
              echo "✅ New template: $template_name"
              cp -rv "$SOURCE" void-packages/srcpkgs/
              continue
            fi

            SOURCE_TEMPLATE="$SOURCE/template"
            DEST_TEMPLATE="$DESTINATION/template"

            if [ ! -f "$SOURCE_TEMPLATE" ]; then
              echo "❌ Source template file missing: $SOURCE_TEMPLATE"
              continue
            fi

            if [ ! -f "$DEST_TEMPLATE" ]; then
              echo "✅ Destination template missing, copying: $template_name"
              rm -rf "$DESTINATION"
              cp -rv "$SOURCE" void-packages/srcpkgs/
              continue
            fi

            # Extract version and revision
            SRC_VERSION=$(grep '^version=' "$SOURCE_TEMPLATE" | cut -d'=' -f2 | tr -d '"' | tr -d "'" | xargs)
            SRC_REVISION=$(grep '^revision=' "$SOURCE_TEMPLATE" | cut -d'=' -f2 | tr -d '"' | tr -d "'" | xargs)
            DST_VERSION=$(grep '^version=' "$DEST_TEMPLATE" | cut -d'=' -f2 | tr -d '"' | tr -d "'" | xargs)
            DST_REVISION=$(grep '^revision=' "$DEST_TEMPLATE" | cut -d'=' -f2 | tr -d '"' | tr -d "'" | xargs)

            SRC_REVISION=${SRC_REVISION:-1}
            DST_REVISION=${DST_REVISION:-1}

            echo "Comparing: $template_name"
            echo "  Source: $SRC_VERSION-$SRC_REVISION"
            echo "  Dest:   $DST_VERSION-$DST_REVISION"

            # Compare versions
            SHOULD_UPDATE=false
            if [ "$SRC_VERSION" != "$DST_VERSION" ]; then
              NEWER=$(printf '%s\n%s\n' "$SRC_VERSION" "$DST_VERSION" | sort -V | tail -n1)
              if [ "$NEWER" = "$SRC_VERSION" ]; then
                SHOULD_UPDATE=true
              fi
            else
              if [ "$SRC_REVISION" -gt "$DST_REVISION" ]; then
                SHOULD_UPDATE=true
              fi
            fi

            if [ "$SHOULD_UPDATE" = true ]; then
              echo "✅ Newer version found, updating: $template_name"
              rm -rf "$DESTINATION"
              cp -rv "$SOURCE" void-packages/srcpkgs/
            else
              echo "⏭️ Skipping older/same version: $template_name"
            fi
          done

          # Update shlibs
          SHLIBS_FILE="void-packages/common/shlibs"
          APPEND_FILE="extra/shlibs_append"
          REMOVE_FILE="extra/shlibs_remove"

          if [ -f "$REMOVE_FILE" ]; then
            echo "==> Removing shlibs entries"
            while IFS= read -r line; do
              [ -z "$line" ] && continue
              grep -vF "$line" "$SHLIBS_FILE" > "$SHLIBS_FILE.tmp" && mv "$SHLIBS_FILE.tmp" "$SHLIBS_FILE"
              echo "   - $line"
            done < "$REMOVE_FILE"
          fi

          if [ -f "$APPEND_FILE" ]; then
            echo "==> Adding shlibs entries"
            while IFS= read -r line; do
              [ -z "$line" ] && continue
              if ! grep -qF "$line" "$SHLIBS_FILE"; then
                echo "$line" >> "$SHLIBS_FILE"
                echo "   + $line"
              fi
            done < "$APPEND_FILE"
          fi

      - name: Prepare masterdir
        run: |
          cd void-packages
          chown -R builder:builder .
          sudo -Eu builder common/travis/set_mirror.sh
          sudo -Eu builder common/travis/prepare.sh
          common/travis/fetch-xtools.sh

      - name: Clone repo
        env:
          ARCH: ${{ matrix.config.arch }}
          XBPS_ARCH: ${{ matrix.config.arch }}
          XBPS_TARGET_ARCH: ${{ matrix.config.arch }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: VUR-${{ matrix.config.arch }}
          BRANCH: bin
          TOKEN: ${{ secrets.TOKEN }}
        run: |
          export XBPS_TARGET_ARCH="${XBPS_ARCH}"

          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          echo "==> Target repository: ${REPO_OWNER}/${REPO_NAME}"
          REMOTE="https://${REPO_OWNER}:${TOKEN}@github.com/${REPO_OWNER}/${REPO_NAME}.git"

          cd void-packages/hostdir

          # Clone or init repository
          if git clone --depth 1 --branch "$BRANCH" "$REMOTE" binpkgs 2>/dev/null; then
            echo "==> Repository exists, using existing branch"
            cd temp_repo
          elif git clone --depth 1 "$REMOTE" binpkgs 2>/dev/null; then
            echo "==> Repository exists, creating new branch"
            cd temp_repo
            git checkout -b "$BRANCH"
          else
            echo "==> Initializing new repository"
            git init binpkgs
            cd binpkgs
            git checkout -b "$BRANCH"

            # Setup Git LFS
            git lfs install
            echo "*.xbps filter=lfs diff=lfs merge=lfs -text" > .gitattributes
            git add .gitattributes

            # Create README
            TEMPLATE_PATH="../.github/README-template.md"
            if [ -f "$TEMPLATE_PATH" ]; then
              sed -e "s/\${ARCH}/${ARCH}/g" \
                -e "s/\${REPO_OWNER}/${REPO_OWNER}/g" \
                -e "s/\${REPO_NAME}/${REPO_NAME}/g" \
                "$TEMPLATE_PATH" > README.md
              git add README.md
            fi

            git commit -m "Initial commit"
            git push -u origin "$BRANCH"
          fi

          # Ensure LFS tracking
          git lfs track "*.xbps" 2>/dev/null || true
          # Copy signed repo
          cp ../../void-packages/hostdir/binpkgs/* ./
          

      - name: Build packages
        run: |
          export PATH="/opt/xbps/usr/bin/:$PATH"
          cd void-packages
          packages="${{ needs.lint.outputs.packages }}"

          if [ "$BOOTSTRAP" != "$ARCH" ]; then
            arch="-a $ARCH"
          fi

          if [ "$TEST" = 1 ]; then
            test="-Q"
          fi

          echo "==> Resolving dependencies for: $packages"
          PKGS=$(sudo -Eu builder ./xbps-src $test sort-dependencies $packages)
          failed=""

          echo "==> Build order with dependencies:"
          echo "$PKGS"
          echo

          for pkg in ${PKGS}; do
            echo "==> Building ${pkg}"
            if ! sudo -Eu builder ./xbps-src -j"$(nproc)" -s $arch $test pkg "${pkg}"; then
              echo "⚠️ build failed: ${pkg}"
              failed="${failed} ${pkg}"
            else
              echo
              echo "✅ ${pkg} built successfully"
            fi
            echo
            echo
          done

          if [ -n "${failed}" ]; then
            echo "## ❌ Failed builds" >> $GITHUB_STEP_SUMMARY
            for f in ${failed}; do
              echo "  - ${f}" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "✅ All builds succeeded"
          fi

      - name: Sign packages
        env:
          PRIV_KEY: ${{ secrets.PRIV_KEY }}
          ARCH: ${{ matrix.config.arch }}
          XBPS_ARCH: ${{ matrix.config.arch }}
          XBPS_TARGET_ARCH: ${{ matrix.config.arch }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: VUR-${{ matrix.config.arch }}
          BRANCH: bin
          TOKEN: ${{ secrets.TOKEN }}
        working-directory: void-packages/hostdir/binpkgs/
        run: |
          export PATH="/opt/xbps/usr/bin/:$PATH"
          export XBPS_TARGET_ARCH="${XBPS_ARCH}"

          # Check if there are packages to sign
          if ! ls *.xbps 1>/dev/null 2>&1; then
            echo "⚠️ No packages to sign"
            exit 0
          fi

          echo "==> Writing private key"
          printf "%s\n" "$PRIV_KEY" > private.pem
          chmod 600 private.pem

          echo "==> Merging free + nonfree"
          if [ -d "nonfree" ]; then
            mv nonfree/*.xbps . 2>/dev/null || true
          fi

          echo "==> Signing packages"

          echo "==> Indexing packages"
          xbps-rindex -a *.xbps || true

          echo "==> Creating repository data"
          xbps-rindex -s "$PWD"

          echo "==> Signing repository"
          xbps-rindex --signedby "zenobit <zenobit@disroot.org>" --privkey private.pem "$PWD"

          echo "==> Signing individual packages"
          xbps-rindex --privkey private.pem "$PWD"/*.xbps
          xbps-rindex -c "$PWD"

          echo "==> Cleaning up private key"
          rm -f private.pem

      - name: Push to repository
        if: success()
        env:
          ARCH: ${{ matrix.config.arch }}
          XBPS_ARCH: ${{ matrix.config.arch }}
          XBPS_TARGET_ARCH: ${{ matrix.config.arch }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: VUR-${{ matrix.config.arch }}
          BRANCH: bin
          TOKEN: ${{ secrets.TOKEN }}
        run: |
          export XBPS_TARGET_ARCH="${XBPS_ARCH}"
          cd extra
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          echo "==> Target repository: ${REPO_OWNER}/${REPO_NAME}"
          REMOTE="https://${REPO_OWNER}:${TOKEN}@github.com/${REPO_OWNER}/${REPO_NAME}.git"

          cd void-packages/hostdir

          # Clone or init repository
          if git clone --depth 1 --branch "$BRANCH" "$REMOTE" binpkgs 2>/dev/null; then
            echo "==> Repository exists, using existing branch"
            cd temp_repo
          elif git clone --depth 1 "$REMOTE" binpkgs 2>/dev/null; then
            echo "==> Repository exists, creating new branch"
            cd temp_repo
            git checkout -b "$BRANCH"
          else
            echo "==> Initializing new repository"
            git init binpkgs
            cd binpkgs
            git checkout -b "$BRANCH"

            # Setup Git LFS
            git lfs install
            echo "*.xbps filter=lfs diff=lfs merge=lfs -text" > .gitattributes
            git add .gitattributes

            # Create README
            TEMPLATE_PATH="../.github/README-template.md"
            if [ -f "$TEMPLATE_PATH" ]; then
              sed -e "s/\${ARCH}/${ARCH}/g" \
                -e "s/\${REPO_OWNER}/${REPO_OWNER}/g" \
                -e "s/\${REPO_NAME}/${REPO_NAME}/g" \
                "$TEMPLATE_PATH" > README.md
              git add README.md
            fi

            git commit -m "Initial commit"
            git push -u origin "$BRANCH"
          fi

          # Ensure LFS tracking
          git lfs track "*.xbps" 2>/dev/null || true
          # Copy signed repo
          cp ../../void-packages/hostdir/binpkgs/* ./

          # Remove packages for deleted templates
          removed="${{ needs.lint.outputs.removed }}"
          if [ -n "$removed" ]; then
            echo "==> Removing packages for deleted templates: $removed"
            for pkg in $removed; do
              if ls "${pkg}"-*.xbps 2>/dev/null; then
                git rm "${pkg}"-*.xbps "${pkg}"-*.xbps.sig2 2>/dev/null || true
                echo "  Removed: $pkg"
              fi
            done
            git commit -m "Remove packages for deleted templates" || true
          fi

          # Process built packages
          if [ -d "../../void-packages/hostdir/binpkgs" ]; then
            echo "==> Processing packages"
            for new_pkg in ../../void-packages/hostdir/binpkgs/*.xbps; do
              [ -f "$new_pkg" ] || continue

              new_basename=$(basename "$new_pkg")
              new_sig="${new_pkg}.sig2"

              # Extract package name and version
              new_basename_no_ext="${new_basename%.xbps}"
              pkg_version=$(echo "$new_basename_no_ext" | rev | cut -d'_' -f2- | cut -d'-' -f1 | rev)
              pkg_name=$(echo "$new_basename_no_ext" | rev | cut -d'_' -f2- | cut -d'-' -f2- | rev)

              echo "Processing: $pkg_name ($pkg_version)"

              # Check if same version exists without signature
              missing_sig=false
              if [ -f "${new_basename}" ] && [ ! -f "${new_basename}.sig2" ]; then
                echo "  Package exists without signature"
                missing_sig=true
                rm -f "${new_basename}"
              fi

              # Remove old versions
              had_old_version=false
              for old_pkg in "${pkg_name}"-*.xbps; do
                [ -f "$old_pkg" ] || continue
                [ "$old_pkg" = "$new_basename" ] && continue
                echo "  Removing old: $old_pkg"
                git rm -f "$old_pkg" "${old_pkg}.sig2" 2>/dev/null || rm -f "$old_pkg" "${old_pkg}.sig2"
                had_old_version=true
              done

              # Copy new package and signature
              cp "$new_pkg" ./
              [ -f "$new_sig" ] && cp "$new_sig" ./ || echo "⚠️ No signature for $new_basename"

              # Stage and commit
              git add "${new_basename}" "${new_basename}.sig2" 2>/dev/null || git add "${new_basename}"

              if [ "$missing_sig" = true ]; then
                git commit -m "$pkg_name: reupload $pkg_version with signature" || true
              elif [ "$had_old_version" = true ]; then
                git commit -m "$pkg_name: update to $pkg_version" || true
              else
                git commit -m "New package: $pkg_name-$pkg_version" || true
              fi
            done

            # Update repository index
            export PATH="/opt/xbps/usr/bin/:$PATH"
            echo "==> Updating repository index"
            xbps-rindex -a *.xbps 2>/dev/null || true
            #xbps-rindex -c "$PWD"

            git add "${{ matrix.config.arch }}-repodata" 2>/dev/null || true
            git commit -m "Update repository index" || true
          fi

          # Push all commits
          if ! git push origin "$BRANCH"; then
            echo "❌ Push failed!" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          git status

          echo "==> Successfully pushed to https://${REPO_OWNER}/${REPO_NAME}"
