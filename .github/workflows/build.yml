name: matrix build

on:
  #push:
  #  branches:
  #    - master
  #    - main
  #  paths:
  #    - 'srcpkgs/**'
  repository_dispatch:
    types: [build]
  workflow_dispatch:
    inputs:
      templates:
        description: 'Build multiple packages'
        required: false
        default: ""
        type: string
      template:
        description: 'Build single package'
        required: false
        default: ''
        type: choice
        options:
        -
        - aquamarine
        - glaze
        - hyprcursor
        - hyprdynamicmonitors
        - hyprgraphics
        - hypridle
        - hyprland
        - hyprland-guiutils
        - hyprland-protocols
        - hyprland-qt-support
        - hyprlang
        - hyprlock
        - hyprpaper
        - hyprpicker
        - hyprpolkitagent
        - hyprsunset
        - hyprsysteminfo
        - hyprtoolkit
        - hyprutils
        - hyprwayland-scanner
        - libspng
        - ly
        - nebula-gtk
        - sdbus-cpp
        - shattered-pixel-dungeon
        - tomlplusplus
        - vbm
        - xdg-desktop-portal-hyprland
        - zen-browser
        - zig

permissions:
  contents: write

jobs:
  build:
    name: Build packages
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/void-linux/void-${{ matrix.config.libc }}-full:20250616R1
      options: --platform ${{ matrix.config.platform }} --privileged
      volumes:
        - /dev:/dev
      env:
        ARCH: '${{ matrix.config.arch }}'
        BOOTSTRAP: '${{ matrix.config.host }}'
        TEST: '${{ matrix.config.test }}'
    strategy:
      fail-fast: false
      matrix:
        config:
          - { arch: x86_64,       host: x86_64,      libc: glibc, platform: linux/amd64, test: 1 }
          - { arch: aarch64,      host: x86_64,      libc: glibc, platform: linux/amd64, test: 0 }
          - { arch: x86_64-musl,  host: x86_64-musl, libc: musl,  platform: linux/amd64, test: 1 }
          - { arch: aarch64-musl, host: x86_64-musl, libc: musl,  platform: linux/amd64, test: 0 }

    steps:
      - name: Prepare container
        run: |
          # switch to repo-ci mirror
          mkdir -p /etc/xbps.d && cp /usr/share/xbps.d/*-repository-*.conf /etc/xbps.d/
          sed -i 's|repo-default|repo-ci|g' /etc/xbps.d/*-repository-*.conf
          # install dependencies
          xbps-install -Syu xbps && xbps-install -yu && xbps-install -y sudo bash curl git git-lfs
          # create non-root user
          useradd -G xbuilder -M builder

      - name: Checkout this repo
        run: |
          git clone --depth 1 "https://github.com/${{ github.repository }}.git" extra
          cd extra
          git fetch --no-tags origin "${{ github.sha }}" --depth 1
          git checkout --detach "${{ github.sha }}"

      - name: Checkout void-packages
        run: |
          git clone --depth 1 https://github.com/void-linux/void-packages.git void-packages
          cd void-packages
          git checkout --detach master

      - name: Merge templates and edit shlibs
        run: |
          echo "==> copying templates..."
          # Use inputs
          # All templates
          if [ -z "${{ inputs.template }}" ] && [ -z "${{ inputs.templates }}" ]; then
            for template in extra/srcpkgs/*; do
              template_name=$(basename "$template")
              original="void-packages/srcpkgs/$template_name"
              if [ -d "$original" ]; then
                echo "Removing old template directory: $template"
                rm -rf "$original" || echo "Cannot remove $original"
              fi
              cp -rv $template void-packages/srcpkgs/
            done
          # Only 1 template
          elif [ ! -z "${{ inputs.template }}" ]; then
            if [ -d "void-packages/srcpkgs/${{ inputs.template }}" ]; then
              echo "Removing old template directory: ${{ inputs.template }}"
              rm -rf "void-packages/srcpkgs/${{ inputs.template }}" || echo "Cannot remove ${{ inputs.template }}"
            fi
            cp -rv extra/srcpkgs/${{ inputs.template }} void-packages/srcpkgs/
          # More templates
          elif [ ! -z "${{ inputs.templates }}" ]; then
            for template in "${{ inputs.templates }}"; do
              template_name=$(basename "$template")
              original="void-packages/srcpkgs/$template_name"
              if [ -d "$original" ]; then
                echo "Removing old template directory: $template"
                rm -rf "$original" || echo "Cannot remove $original"
              fi
              cp -rv "extra/srcpkgs/$template" void-packages/srcpkgs/
            done
          fi

          SHLIBS_FILE="void-packages/common/shlibs"
          APPEND_FILE="extra/shlibs_append"
          REMOVE_FILE="extra/shlibs_remove"

          echo "==> updating common/shlibs..."
          if [ -f "$REMOVE_FILE" ]; then
            while IFS= read -r line; do
              [ -z "$line" ] && continue
              grep -vF "$line" "$SHLIBS_FILE" > "$SHLIBS_FILE.tmp" && mv "$SHLIBS_FILE.tmp" "$SHLIBS_FILE"
              echo "   - removed: $line"
            done < "$REMOVE_FILE"
          fi

          if [ -f "$APPEND_FILE" ]; then
            while IFS= read -r line; do
              [ -z "$line" ] && continue
              if ! grep -qF "$line" "$SHLIBS_FILE"; then
                echo "$line" >> "$SHLIBS_FILE"
                echo "   + added: $line"
              fi
            done < "$APPEND_FILE"
          fi

          #echo "=> applying inline edits..."
          #if [ -d "void-packages/srcpkgs/hyprutils/patches" ]; then
          #    echo "   - removing void-packages/srcpkgs/hyprutils/patches"
          #    rm -rf void-packages/srcpkgs/hyprutils/patches
          #fi

      - name: Prepare masterdir
        run: |
          cd void-packages
          chown -R builder:builder . &&
          sudo -Eu builder common/travis/set_mirror.sh &&
          sudo -Eu builder common/travis/prepare.sh &&
          common/travis/fetch-xtools.sh

      - name: Lint & Build
        run: |
          export PATH="/opt/xbps/usr/bin/:$PATH"
          cd void-packages
          if [ -z "${{ inputs.template }}" ] && [ -z "${{ inputs.templates }}" ]; then
            pkgs=$(find ../extra/srcpkgs -maxdepth 1 -mindepth 1 -type d -printf "%f\n")
          elif [ ! -z "${{ inputs.template }}" ]; then
            pkgs=${{ inputs.template }}
          elif [ ! -z "${{ inputs.templates }}" ]; then
            pkgs=${{ inputs.templates }}
          fi

          if [ "$BOOTSTRAP" != "$ARCH" ]; then
              arch="-a $ARCH"
          fi

          if [ "$TEST" = 1 ]; then
              test="-Q"
          fi

          PKGS=$(sudo -Eu builder ./xbps-src $test sort-dependencies $pkgs)
          failed=""

          echo "==> Build order with dependencies:"
          echo "$PKGS"
          echo

          for pkg in ${PKGS}; do
            echo ''
            echo "==> Linting ${pkg}"
            echo ''
            for template in ${pkg}; do
                sudo -Eu builder xlint ${template}"
            done
            echo ''
            echo "==> Building ${pkg}"
            echo ''
            if ! sudo -Eu builder ./xbps-src -j"$(nproc)" -s $arch $test pkg "${pkg}"; then
              echo "!! build failed for ${pkg}"
              failed="${failed} ${pkg}"
            fi
          done

          if [ -n "${failed}" ]; then
            echo
            echo "Failed builds:" >> $GITHUB_STEP_SUMMARY
            for f in ${failed}; do
                echo "  - ${f}" >> $GITHUB_STEP_SUMMARY
            done
          fi

      - name: Sign packages
        env:
          PRIV_KEY: ${{ secrets.PRIV_KEY }}
          XBPS_ARCH: ${{ matrix.config.arch }}
        working-directory: void-packages/hostdir/binpkgs/
        run: |
          export PATH="/opt/xbps/usr/bin/:$PATH"

          echo "==> writing private key to file..."
          printf "%s\n" "$PRIV_KEY" > private.pem
          chmod 600 private.pem

          echo "==> merging free + nonfree"
          if [ -d "nonfree" ]; then
              mv nonfree/*.xbps .
          fi

          # Index and sign packages
          xbps-rindex -a *.xbps
          xbps-rindex -r "$PWD"
          xbps-rindex -s --signedby "zenobit <zenobit@disroot.org>" --privkey private.pem "$PWD"
          xbps-rindex -S --privkey private.pem "$PWD"/*.xbps
          xbps-rindex -c "$PWD"

          echo "==> cleaning up private key..."
          rm -f private.pem

      - name: Set release tag
        id: set_tag
        run: echo "tag=build-$(date +'%Y%m%d-%H%M%S')" >> "$GITHUB_OUTPUT"

      - name: Push binpkgs (per arch)
        env:
          REPO_OWNER: ${{ github.repository_owner }}
          TOKEN: ${{ secrets.TOKEN }}
          REPO_NAME: VUR-${{ matrix.config.arch }}
          BRANCH: bin
        run: |
          cd extra
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          echo "==> Target repository: ${REPO_OWNER}/${REPO_NAME}"
          REMOTE="https://${REPO_OWNER}:${TOKEN}@github.com/${REPO_OWNER}/${REPO_NAME}.git"

          # Shallow clone
          REPO_EXISTS=true
          git clone --depth 1 --branch "$BRANCH" "$REMOTE" temp_repo || REPO_EXISTS=false

          if [ "$REPO_EXISTS" = false ]; then
            echo "==> Initializing new repository..."
            git init temp_repo
            cd temp_repo

            # Setup Git LFS
            git lfs install || true
            echo "*.xbps filter=lfs diff=lfs merge=lfs -text" > .gitattributes

            # Create README from template
            TEMPLATE_PATH=$(find "$GITHUB_WORKSPACE" -name "README-template.md")
            if [ -f "$TEMPLATE_PATH" ]; then
              sed -e "s/\${ARCH}/${ARCH}/g" \
               -e "s/\${REPO_OWNER}/${REPO_OWNER}/g" \
               -e "s/\${REPO_NAME}/${REPO_NAME}/g" \
               "$TEMPLATE_PATH" > README.md
            else
              echo "ERROR: README-template.md not found!"
            fi

            git add .gitattributes README.md
            git commit -m "Initial commit"
          else
            cd temp_repo

            # Remove last updated line from existing README if present
            if [ -f README.md ]; then
              if grep -q "Last updated:\|Last Updated:\|last updated:" README.md; then
                echo "==> Removing 'Last updated' line from README..."
                sed -i '/Last updated:\|Last Updated:\|last updated:/d' README.md
                git add README.md
                git commit -m "Remove last updated timestamp from README" || true
              fi
            fi
          fi

          # Process each package individually
          echo "==> Processing packages..."
          for new_pkg in ../../void-packages/hostdir/binpkgs/*.xbps; do
            [ -f "$new_pkg" ] || continue

            new_basename=$(basename "$new_pkg")
            new_sig="${new_pkg}.sig"

            # Extract package name and version
            new_basename_no_ext=$(echo "$new_basename" | sed 's/\.xbps$//')
            pkg_version=$(echo "$new_basename_no_ext" | grep -oP '(?<=-)[0-9]+\.[^_]+(?=_)')
            pkg_name=$(echo "$new_basename_no_ext" | sed -E "s/-${pkg_version}_.*//" )
            echo "Processing: $pkg_name ($pkg_version)"

            # Remove old versions of this package
            old_files=$(ls "${pkg_name}"-*.xbps "${pkg_name}"-*.xbps.sig 2>/dev/null || true)
            if [ -n "$old_files" ]; then
              echo "Removing old versions..."
              rm -f "${pkg_name}"-*.xbps "${pkg_name}"-*.xbps.sig 2>/dev/null || true
            fi

            # Copy new package and signature
            cp "$new_pkg" ./
            [ -f "$new_sig" ] && cp "$new_sig" ./ || true

            # Commit this package
            git add "${new_basename}" "${new_basename}.sig" 2>/dev/null || git add "${new_basename}"

            if [ -n "$old_files" ]; then
              git commit -m "$pkg_name: update to $pkg_version" || true
            else
              git commit -m "New package: $pkg_name-$pkg_version" || true
            fi
          done

          # Push all commits
          git push origin "$BRANCH"

          echo "==> Successfully pushed to ${REPO_OWNER}/${REPO_NAME}"
